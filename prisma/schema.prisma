generator client {
  provider = "prisma-client-js"
  output   = "../src/app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Configuraciones globales para el sistema
model AppConfig {
  id Int @id @default(1) @map("_id") // Config 煤nica (singleton)

  // General
  logoUrl                   String? @db.VarChar(255)
  isMaintenanceMode         Boolean @default(false) // 驴La plataforma est谩 en mantenimiento?
  googleAnalyticsTrackingId String? // ID de seguimiento de Google Analytics
  // considerar redes sociales pagina de mantenimiento tambi茅n la necesita o solo incluir en el footer

  // Usuario
  isUserSignUpEnabled               Boolean @default(true) // Permitir registros
  maxActiveSessionsPerUser          Int?    @default(3) // L铆mite de sesiones por usuario
  isSingleUserPerIpOrDeviceEnforced Boolean @default(false) // 驴Evitar m煤ltiples usuarios por IP?
  isEmailVerificationRequired       Boolean @default(false) // 驴Verificaci贸n de email requerida?
  isGlobalTwoFactorAuthEnabled      Boolean @default(false) // 驴Est谩 activo el 2FA globalmente?
  sessionTimeoutLimitMinutes        Int?    @default(30) // Tiempo de expiraci贸n de sesi贸n en minutos

  // SEO Global
  siteDisplayName      String? // Nombre de la plataforma
  siteUrl              String? // URL principal (https://midominio.com)
  siteDescription      String? @db.VarChar(255)
  faviconUrl           String? @db.VarChar(255)
  defaultLocale        String  @default("es")
  isSiteNoIndexEnabled Boolean @default(false)
  seoDefaultKeywords   String? @db.VarChar(255)

  // SMTP Config
  emailHost         String? @db.VarChar(255)
  emailPort         Int?    @default(587)
  emailUser         String? @db.VarChar(255) // Correo de contacto o soporte
  emailPassEnc      String? @db.Text // Encriptada
  isEmailConfigured Boolean @default(false) // Indica si est谩 listo para usar

  createdAt DateTime @default(now()) // Fecha de creaci贸n
  updatedAt DateTime @updatedAt // Fecha de 煤ltima modificaci贸n
}

// Sesiones activas por usuario
model User {
  id                 String    @id @default(cuid()) // ID 煤nico del usuario
  email              String    @unique // Email del usuario
  emailVerified      DateTime? // Fecha en que se verific贸 el email
  hashedPassword     String? // Hash de la contrase帽a
  name               String? // Nombre opcional
  image              String?   @db.VarChar(255) // Avatar o imagen de perfil
  isTwoFactorEnabled Boolean   @default(false) // 驴Tiene 2FA activado?
  twoFactorSecretKey String? // Clave secreta para 2FA
  role               Role      @default(USER) // El Rol que hace este usuario
  createdAt          DateTime  @default(now()) // Fecha de creaci贸n
  updatedAt          DateTime  @updatedAt // Fecha de 煤ltima modificaci贸n

  sessions          UserSession[] // Relaci贸n con sesiones activas
  loginAttempts     UserLoginAttempt[] // Relaci贸n con intentos de login
  registrations     UserRegistrationLog[] // Registros de IP/dispositivo en registro
  auditLogs         UserAuditLog[] // Acciones del usuario
  verificationToken UserVerificationToken[] // Registro de Tokens
  blockedIp         UserBlockedIp[]
  blockedIpLog      UserBlockedIpLog[]

  // t茅rminos y condiciones
  // acceptedTermsAt DateTime?
  // acceptedPrivacyPolicyAt DateTime?

  //  referidos
  // referralCode String? @unique
  // referredBy   String? // ID del usuario que refiri贸
  // referrer     User?   @relation("Referrals", fields: [referredBy], references: [id])

  @@index([emailVerified]) // 铆ndices en campos frecuentemente consultados:
}

// Sesiones activas por usuario
model UserSession {
  id               String    @id @default(cuid()) // ID de la sesi贸n
  userId           String // Relaci贸n con el usuario
  user             User      @relation(fields: [userId], references: [id])
  ipAddress        String? // Direcci贸n IP de la sesi贸n
  userAgent        String? // Dispositivo/navegador usado
  createdAt        DateTime  @default(now()) // Fecha de creaci贸n
  sessionExpiresAt DateTime? // Fecha de expiraci贸n de la sesi贸n

  @@index([sessionExpiresAt]) // ndice para consultar sesiones expiradas r谩pidamente
  @@index([ipAddress]) // ndice para buscar r谩pidamente sesiones por IP
}

// Tokens para verificaci贸n de email o recuperaci贸n
model UserVerificationToken {
  id                String    @id @default(cuid()) // ID del token
  userId            String // Usuario al que pertenece
  verificationToken String    @unique // Token 煤nico
  tokenType         TokenType // Tipo: "email", "password_reset", etc.
  expiresAt         DateTime // Fecha de expiraci贸n
  createdAt         DateTime  @default(now()) // Fecha de creaci贸n
  updatedAt         DateTime  @updatedAt // Fecha de 煤ltima modificaci贸n

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, tokenType])
  @@index([expiresAt])
  @@map("UserVerificationToken")
}

// Historial de IP/dispositivo al registrarse
model UserRegistrationLog {
  id        String   @id @default(cuid()) // ID del log
  userId    String // Usuario que se registr贸
  user      User     @relation(fields: [userId], references: [id])
  ipAddress String // IP desde donde se registr贸
  deviceId  String? // Identificador del dispositivo
  createdAt DateTime @default(now()) // Fecha del registro

  @@index([ipAddress, deviceId]) // B煤squeda r谩pida por IP
}

// Intentos de login exitosos o fallidos
model UserLoginAttempt {
  id                String   @id @default(cuid()) // ID del intento
  userId            String? // Usuario (opcional si no existe a煤n)
  user              User?    @relation(fields: [userId], references: [id])
  email             String // Email con el que intent贸 entrar
  ipAddress         String? // IP de origen
  isSuccessfulLogin Boolean // 驴Fue exitoso?
  createdAt         DateTime @default(now()) // Fecha del intento

  @@index([ipAddress])
  @@map("UserLoginAttempt")
}

// Registro de acciones importantes del usuario
model UserAuditLog {
  id              String   @id @default(cuid()) // ID del log
  userId          String // Usuario que hizo la acci贸n
  user            User     @relation(fields: [userId], references: [id])
  auditAction     String // Acci贸n realizada (ej: login, update-profile)
  ipAddress       String? // IP de origen
  metadata        Json? // guardar datos adicionales como payloads, IDs afectados, etc.
  userAgentString String? // Navegador/dispositivo usado
  createdAt       DateTime @default(now()) // Fecha del evento
  updatedAt       DateTime @updatedAt // Fecha de 煤ltima modificaci贸n

  @@index([createdAt])
  @@map("UserAuditLog")
}

// IPs bloqueadas manual o autom谩ticamente
model UserBlockedIp {
  id                  String    @id @default(cuid()) // ID 煤nico para el bloqueo
  ipAddress           String    @unique // IP bloqueada
  blockReason         String? // Raz贸n del bloqueo (ej: "intentos fallidos", "actividad sospechosa")
  failedLoginAttempts Int       @default(0) // N煤mero de intentos fallidos antes de bloquear
  userId              String? // Relaci贸n opcional con el usuario
  User                User?     @relation(fields: [userId], references: [id])
  blockStartAt        DateTime  @default(now()) // Fecha de bloqueo
  blockExpiresAt      DateTime? //manejar bloqueos temporales.

  @@index([blockStartAt])
  @@map("UserBlockedIp")
}

//  Propuesta de flujo (automatizable):
// En cada intento de login fallido, se graba un UserLoginAttempt.
// Se cuenta cu谩ntos intentos fallidos tiene esa IP en los 煤ltimos X minutos.
// Si supera el umbral, se crea (o actualiza) un UserBlockedIp.
// En cada login o request, se revisa si la IP est谩 en UserBlockedIp (y si el bloqueo no ha expirado).
// Opcional: usar expiresAt para manejar bloqueos temporales.
// Si piensas usar limpieza autom谩tica de bloqueos expirados, considera una tarea cron cada X horas que elimine los expirados
// DELETE FROM "UserBlockedIp" WHERE "expiresAt" IS NOT NULL AND "expiresAt" < NOW();

// para llevar un historial permanente de las veces que sea bloqueado un usuario
model UserBlockedIpLog {
  id                  String    @id @default(cuid())
  ipAddress           String
  blockReason         String?
  failedLoginAttempts Int
  blockStartAt        DateTime
  blockEndAt          DateTime? // Si se elimin贸 el bloqueo
  userId              String?
  user                User?     @relation(fields: [userId], references: [id])
}

enum Role {
  USER
  ADMIN
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR_AUTH
  ACCOUNT_DELETION
}
