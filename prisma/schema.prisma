generator client {
  provider = "prisma-client-js"
  output   = "../src/app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Configuraciones globales para el sistema
model AppConfig {
  id Int @id @default(1) @map("_id") // Config 煤nica (singleton)

  // General
  contactEmail      String? // Correo de contacto o soporte
  logoUrl           String? @db.VarChar(255)
  maintenanceMode   Boolean @default(false) // 驴La plataforma est谩 en mantenimiento?
  googleAnalyticsId String? // ID de seguimiento de Google Analytics

  // Usuario
  allowUserSignUps           Boolean @default(true) // Permitir registros
  maxActiveSessionsPerUser   Int?    @default(3) // L铆mite de sesiones por usuario
  restrictMultipleUsersPerIp Boolean @default(false) // 驴Evitar m煤ltiples usuarios por IP?
  requireEmailVerification   Boolean @default(true) // 驴Verificaci贸n de email requerida?
  enable2FA                  Boolean @default(false) // 驴Est谩 activo el 2FA globalmente?
  sessionTimeoutMinutes      Int?    @default(30) // Tiempo de expiraci贸n de sesi贸n en minutos

  // SEO Global
  platformName        String? // Nombre de la plataforma
  platformUrl         String? // URL principal (https://midominio.com)
  platformDescription String? @db.VarChar(255)
  faviconUrl          String? @db.VarChar(255)
  defaultLocale       String  @default("es")
  globalNoIndex       Boolean @default(false)
  globalKeywords      String? @db.VarChar(255)
  // Tambi茅n puedes usarlo para evitar que se genere el sitemap.xml completo o devolver un archivo robots.txt que bloquee todo (User-agent: * Disallow: /).

  createdAt DateTime @default(now()) // Fecha de creaci贸n
  updatedAt DateTime @updatedAt // Fecha de 煤ltima modificaci贸n
}

// Sesiones activas por usuario
model User {
  id               String    @id @default(cuid()) // ID 煤nico del usuario
  email            String    @unique // Email del usuario
  emailVerified    DateTime? // Fecha en que se verific贸 el email
  passwordHash     String // Hash de la contrase帽a
  name             String? // Nombre opcional
  image            String?   @db.VarChar(255) // Avatar o imagen de perfil
  twoFactorEnabled Boolean   @default(false) // 驴Tiene 2FA activado?
  twoFactorSecret  String? // Clave secreta para 2FA
  role             Role      @default(USER) // El Rol que hace este usuario
  createdAt        DateTime  @default(now()) // Fecha de creaci贸n
  updatedAt        DateTime  @updatedAt // Fecha de 煤ltima modificaci贸n

  sessions          UserSession[] // Relaci贸n con sesiones activas
  loginAttempts     UserLoginAttempt[] // Relaci贸n con intentos de login
  registrations     UserRegistrationLog[] // Registros de IP/dispositivo en registro
  auditLogs         UserAuditLog[] // Acciones del usuario
  verificationToken UserVerificationToken[] // Registro de Tokens
  blockedIp         UserBlockedIp[]
  blockedIpLog      UserBlockedIpLog[]

  @@index([emailVerified]) // 铆ndices en campos frecuentemente consultados:
}

// Sesiones activas por usuario
model UserSession {
  id        String    @id @default(cuid()) // ID de la sesi贸n
  userId    String // Relaci贸n con el usuario
  user      User      @relation(fields: [userId], references: [id])
  ip        String? // Direcci贸n IP de la sesi贸n
  userAgent String? // Dispositivo/navegador usado
  createdAt DateTime  @default(now()) // Fecha de creaci贸n
  expiresAt DateTime? // Fecha de expiraci贸n de la sesi贸n

  @@index([expiresAt]) // ndice para consultar sesiones expiradas r谩pidamente
  @@index([ip]) // ndice para buscar r谩pidamente sesiones por IP
}

// Tokens para verificaci贸n de email o recuperaci贸n
model UserVerificationToken {
  id        String    @id @default(cuid()) // ID del token
  userId    String // Usuario al que pertenece
  token     String    @unique // Token 煤nico
  type      TokenType // Tipo: "email", "password_reset", etc.
  expiresAt DateTime // Fecha de expiraci贸n
  createdAt DateTime  @default(now()) // Fecha de creaci贸n
  updatedAt DateTime  @updatedAt // Fecha de 煤ltima modificaci贸n

  user User @relation(fields: [userId], references: [id])

  @@index([expiresAt])
  @@map("UserVerificationToken")
}

// Historial de IP/dispositivo al registrarse
model UserRegistrationLog {
  id        String   @id @default(cuid()) // ID del log
  userId    String // Usuario que se registr贸
  user      User     @relation(fields: [userId], references: [id])
  ip        String // IP desde donde se registr贸
  country   String? // Pa铆s detectado seg煤n la IP
  deviceId  String? // Identificador del dispositivo
  createdAt DateTime @default(now()) // Fecha del registro
}

// Intentos de login exitosos o fallidos
model UserLoginAttempt {
  id        String   @id @default(cuid()) // ID del intento
  userId    String? // Usuario (opcional si no existe a煤n)
  user      User?    @relation(fields: [userId], references: [id])
  email     String // Email con el que intent贸 entrar
  ip        String? // IP de origen
  success   Boolean // 驴Fue exitoso?
  createdAt DateTime @default(now()) // Fecha del intento

  @@index([ip])
  @@map("UserLoginAttempt")
}

// Registro de acciones importantes del usuario
model UserAuditLog {
  id        String   @id @default(cuid()) // ID del log
  userId    String // Usuario que hizo la acci贸n
  user      User     @relation(fields: [userId], references: [id])
  action    String // Acci贸n realizada (ej: login, update-profile)
  ip        String? // IP de origen
  meta      Json? // guardar datos adicionales como payloads, IDs afectados, etc.
  userAgent String? // Navegador/dispositivo usado
  createdAt DateTime @default(now()) // Fecha del evento
  updatedAt DateTime @updatedAt // Fecha de 煤ltima modificaci贸n

  @@index([createdAt])
  @@map("UserAuditLog")
}

// IPs bloqueadas manual o autom谩ticamente
model UserBlockedIp {
  id             String    @id @default(cuid()) // ID 煤nico para el bloqueo
  ip             String    @unique // IP bloqueada
  reason         String? // Raz贸n del bloqueo (ej: "intentos fallidos", "actividad sospechosa")
  failedAttempts Int       @default(0) // N煤mero de intentos fallidos antes de bloquear
  blockedAt      DateTime  @default(now()) // Fecha de bloqueo
  userId         String? // Relaci贸n opcional con el usuario
  User           User?     @relation(fields: [userId], references: [id])
  expiresAt      DateTime? //manejar bloqueos temporales.

  @@index([blockedAt])
  @@map("UserBlockedIp")
}

//  Propuesta de flujo (automatizable):
// En cada intento de login fallido, se graba un UserLoginAttempt.
// Se cuenta cu谩ntos intentos fallidos tiene esa IP en los 煤ltimos X minutos.
// Si supera el umbral, se crea (o actualiza) un UserBlockedIp.
// En cada login o request, se revisa si la IP est谩 en UserBlockedIp (y si el bloqueo no ha expirado).
// Opcional: usar expiresAt para manejar bloqueos temporales.
// Si piensas usar limpieza autom谩tica de bloqueos expirados, considera una tarea cron cada X horas que elimine los expirados
// DELETE FROM "UserBlockedIp" WHERE "expiresAt" IS NOT NULL AND "expiresAt" < NOW();

// para llevar un historial permanente de las veces que sea bloqueado un usuario
model UserBlockedIpLog {
  id             String    @id @default(cuid())
  ip             String
  reason         String?
  failedAttempts Int
  blockedAt      DateTime
  unblockedAt    DateTime? // Si se elimin贸 el bloqueo
  userId         String?
  user           User?     @relation(fields: [userId], references: [id])
}

enum Role {
  USER
  ADMIN
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR_AUTH
  ACCOUNT_DELETION
}

enum SeoType {
  PAGE
  ARTICLE
  VIDEO
  AUDIO
  IMAGE
  PRODUCT
  WEBSITE
  GENRE
  ARTIST
  TAG
  OTHER
}
